"use strict";var App={Models:{Forms:{}},Collections:{},Views:{Forms:{}},Vent:{},Helpers:{}};_.extend(App.Vent,Backbone.Events),App.Helpers={renderContent:function(e){$(".page-content").html(e)},getTemplate:function(e){return _.template($(e).html())},getTypeTemplate:function(e){return this.getTemplate("#"+e+"Cart")},getQueryParam:function(e,t){var i,s,n,r;if(t=t||window.location.search.substring(1),!t)return"";for(i=t.search("&")!==-1?t.split("&"):t.split("; "),s=0,n=i.length;s<n;s++)if(r=i[s].split("="),new RegExp(e,"i").test(r[0]))return r[1];return""},storage:function(e){return function(){function t(){var t,i;switch(arguments.length){case 1:t=e,i=JSON.stringify(arguments[0]);break;case 2:t=arguments[0],i=JSON.stringify(arguments[1]);break;default:return!1}return{name:t,value:i}}var i,s=function(){try{return localStorage.setItem("test","hello"),localStorage.removeItem("test"),!0}catch(e){return!1}}();return i=s?{set:function(){var e=t.apply(this,arguments);return!!e&&(localStorage[e.name]=e.value,!0)},get:function(t){return t=t||e,JSON.parse(localStorage[t]||"{}")}}:{set:function(){var e=t.apply(this,arguments),i=new Date((new Date).getTime()+2592e6);return!!e&&(document.cookie=e.name+"="+e.value+"; path=/; expires="+i.toUTCString(),!0)},get:function(t){return t=t||e,JSON.parse(App.Helpers.getQueryParam(t,document.cookie)||"{}")}}}()}},App.Models.Forms.BaseForm=Backbone.Model.extend({}),App.Models.Forms.Login=App.Models.Forms.BaseForm.extend({defaults:{login:"",password:""},validate:function(e){console.log(e)},login:function(e){this.set(e),this.isValid()||console.log(this.validationError)}}),App.Models.Forms.Recover=App.Models.Forms.BaseForm.extend({defaults:{email:""},validate:function(e){},recover:function(){}}),App.Models.SearchForm=Backbone.Model.extend({defaults:{s:App.Helpers.getQueryParam("s")},search:function(e){var t=new App.Collections.Carts;this.set("s",e),t.fetch({success:function(){var i;e&&(i=new RegExp(e,"i"),t.reset(t.filter(function(e){return i.test(e.get("title"))||i.test(e.get("description"))}))),App.Vent.trigger("collectionLoad",t)}})}}),App.Models.Forms.Sigin=App.Models.Forms.BaseForm.extend({defaults:{login:"",email:"",password:"",password2:""},validate:function(e){},signin:function(){}}),App.Models.Cart=Backbone.Model.extend({defaults:{type:0,title:"",description:"",author:"",mediaLink:"",favorites:0,isFavorite:!1},favoriteToggle:function(){var e=this.get("favorites"),t=this.get("isFavorite");this.set("isFavorite",!t),this.set("favorites",t?--e:++e)},isImage:function(){return 0===this.get("type")},isVideo:function(){return 1===this.get("type")},isText:function(){return 2===this.get("type")}}),App.Models.Layout=Backbone.Model.extend({storage:App.Helpers.storage("Layout"),initialize:function(){this.loadOptions(),this.listenTo(App.Vent,"layoutUpdate",this.update),this.listenTo(App.Vent,"layoutUpdateForce",this.updateForce)},defaults:{sidebar:!0,sidebarCollapsed:!0},update:function(e,t){this.updateOptions(e),this.updateForce(e,t)},updateForce:function(e,t){t=!_.isBoolean(t)||t,e&&this.set(e),t&&App.Vent.trigger("layoutRender")},withSidebar:function(){return this.get("sidebar")},sidebarCollapsed:function(){return this.get("sidebarCollapsed")},toggleSidebar:function(){this.update({sidebarCollapsed:!this.get("sidebarCollapsed")},!1),setTimeout(function(){App.Vent.trigger("layoutResize")},400)},loadOptions:function(){this.set(this.storage.get())},saveOptions:function(e){this.set(e),this.storage.set(this.toJSON())},updateOptions:function(e){this.loadOptions(),this.saveOptions(e)}}),App.Collections.Carts=Backbone.Collection.extend({url:"assets/js/database/carts.json",model:App.Models.Cart}),App.Views.BaseView=Backbone.View.extend({assign:function(e,t){var i;_.isObject(e)?i=e:(i={},i[e]=t),i&&_.each(i,function(e,t){e.setElement(this.$(t)).render()},this)}}),App.Views.Forms.BaseForm=Backbone.View.extend({events:{"submit form":"submitForm","blur input[name]":"validateInput"},submitForm:function(e){e.preventDefault();var t=$(e.target),i=t.find(":input[name]"),s=!0;s=_.reduce(i,function(e,t){var i=this.validateOne(t);return e===!0?i:e},s,this),s&&this.submit&&this.submit.call(this,e)},validateInput:function(e){return this.validateOne(e.target)},validateOne:function(e){var t,i,s=$(e),n=s.val().trim(),r=s.data("validate")||{};return r.type=s.attr("type")||"text",r.required=!!s.attr("required"),"number"===r.type&&($.isNumeric(r.min)||$.isNumeric(r.max))&&(r.numMin=r.min,r.numMax=r.max,r.min=r.max=void 0),t=_.every(r,function(e,t){return 0!==e&&e&&("type"===t&&(t=e),this.validators[t]&&(i=this.validators[t].call(this,e,n))),!i},this),this.toggleError(s,i),t},validators:{min:function(e,t){if(!(t.length>=e))return"Value length must be greater than "+e+" symbols."},max:function(e,t){if(!(t.length<=e))return"Value length must be less than "+e+" symbols."},numMin:function(e,t){if(!(t>=e))return"Number must be greater than "+e+"."},numMax:function(e,t){if(!(t<=e))return"Number must be less than "+e+"."},required:function(e,t){if(0===t.length)return"Field value is required"},email:function(e,t){var i=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;if(!i.test(t))return"Incorrect email format"},number:function(e,t){if(!$.isNumeric(t))return"Field value must be numeric"},equals:function(e,t){var i=$(e),s=i.attr("placeholder")||$("label[for='"+i.attr("id")+'"]').html();if(i.val()!==t)return"Field value must match "+s}},toggleError:function(e,t){var i=e.next(),s=e.closest(".form-group"),n=t?$('<span class="help-block">'+t+"</span>"):"";t?(s.addClass("has-error").removeClass("has-success"),0!==i.length?i.replaceWith(n):e.after(n)):(s.addClass("has-success").removeClass("has-error"),i&&i.remove())}}),App.Views.Forms.Login=App.Views.Forms.BaseForm.extend({initialize:function(){},template:App.Helpers.getTemplate("#loginForm"),render:function(){return this.setElement(this.template()),this}}),App.Views.Forms.Recover=App.Views.Forms.BaseForm.extend({initialize:function(){},template:App.Helpers.getTemplate("#recoverForm"),render:function(){return this.setElement(this.template()),this}}),App.Views.SearchForm=Backbone.View.extend({events:{"submit form":"submit","keyup [name='s']":"keyup"},template:App.Helpers.getTemplate("#searchform"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},keyup:function(e){var t=$(e.target).val();t.length>2&&this.search(t)},submit:function(e){e.preventDefault();var t=$(e.target).find("input[name='s']").val();this.search(t)},search:function(e){this.model.search(e)}}),App.Views.Forms.Sigin=App.Views.Forms.BaseForm.extend({initialize:function(){},template:App.Helpers.getTemplate("#signinForm"),render:function(){return this.setElement(this.template()),this},submit:function(e){console.log("Form is submitting")}}),App.Views.CartToolbox=App.Views.BaseView.extend({initialize:function(){this.model.on("change:favorites",this.render,this)},events:{"click .rate-button":"toggleRate"},template:App.Helpers.getTemplate("#cartToolbox"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggleRate:function(e){e.preventDefault(),this.model.favoriteToggle()}}),App.Views.Cart=App.Views.BaseView.extend({initSubviews:function(){return this.subviews={},this.subviews[".toolbox"]=new App.Views.CartToolbox({model:this.model}),this.subviews},templates:[App.Helpers.getTypeTemplate("image"),App.Helpers.getTypeTemplate("video"),App.Helpers.getTypeTemplate("text")],render:function(){var e=this.model.toJSON(),t=this.templates[e.type](e);return this.setElement($(t)),this.assign(this.initSubviews()),this.model.isVideo()&&this.scaleMedia(),this},scaleMedia:function(){var e=this.$(".video-frame iframe"),t=e.parent(),i=function(){var i=t.width()/e.attr("width"),s=e.attr("height")*i;t.css("padding-bottom",s)}.bind(this);e.load(i),$(window).resize(i),this.listenTo(App.Vent,"layoutResize",i)}}),App.Views.Carts=Backbone.View.extend({className:"row",initialize:function(){this.listenTo(App.Vent,"collectionLoad",this.setCollection)},setCollection:function(e){this.collection?this.collection.reset(e.models):(this.collection=e,this.listenTo(this.collection,"reset",this.redraw))},render:function(){return this.collection.each(this.addOne,this),this.masonry(),this},redraw:function(){this.reset().render()},reset:function(){return this.$el.html(""),this},addOne:function(e){var t=new App.Views.Cart({model:e});this.$el.append(t.render().el)},masonry:function(){var e=this.$("iframe, img, video"),t=e.length,i=0,s=function(){this.$el.masonry({columnWidth:this.$(".cart-item")[0],itemSelector:".cart-item",percentPosition:!0})}.bind(this);e.load(function(){++i<t||s()}),this.listenTo(App.Vent,"layoutResize",s)}}),App.Views.Topmenu=App.Views.BaseView.extend({template:App.Helpers.getTemplate("#topMenu"),render:function(){return this.$el.html(this.template()),this}}),App.Views.SidebarLayout=App.Views.BaseView.extend({initialize:function(){this.model.on("change:sidebarCollapsed",this.toggleSidebar,this),this.subviews[".searchform"]=new App.Views.SearchForm({model:new App.Models.SearchForm})},subviews:{},template:App.Helpers.getTemplate("#sidebarLayout"),render:function(){return this.setElement(this.template()),this.assign(this.subviews),this.$(".side-wrapper").slimScroll({height:"100%"}),this},toggleSidebar:function(){this.model.get("sidebarCollapsed")?this.$(".side-content").fadeOut(150):this.$(".side-content").hide().delay(300).fadeIn(150)}}),App.Views.ContentLayout=App.Views.BaseView.extend({initialize:function(){this.subviews[".topmenu"]=new App.Views.Topmenu},events:{"click .sidebar-toggle":"toggleSidebar"},subviews:{},template:App.Helpers.getTemplate("#pageLayout"),render:function(){return this.setElement(this.template()),this.assign(this.subviews),this},toggleSidebar:function(){this.model.toggleSidebar()}}),App.Views.Wrapper=App.Views.BaseView.extend({el:"#wrapper",initialize:function(){this.listenTo(App.Vent,"layoutRender",this.render),this.model.on("change:sidebarCollapsed",this.toggleSidebar,this)},initSubviews:function(){this.subviews=[],this.model.withSidebar()&&(this.$el.addClass("with-sidebar"),this.subviews.push(new App.Views.SidebarLayout({model:this.model})),this.model.sidebarCollapsed()&&this.$el.addClass("sidebar-collapsed")),this.subviews.push(new App.Views.ContentLayout({model:this.model}))},template:App.Helpers.getTemplate("#wrapperAppends"),render:function(){this.$el.html("").removeClass(),this.initSubviews(),_.each(this.subviews,function(e){this.$el.append(e.render().el)},this),this.$el.append(this.template())},toggleSidebar:function(){this.$el.toggleClass("sidebar-collapsed")}}),App.Router=Backbone.Router.extend({routes:{"":"index","!/":"index","!/account/signin":"signin","!/account/login":"login","!/account/logout":"logout","!/account/recover":"recover"},index:function(){function e(){App.Vent.trigger("collectionLoad",i),App.Helpers.renderContent(s.render().el)}function t(e,t){console.log(t.responseText)}App.Vent.trigger("layoutUpdate");var i=new App.Collections.Carts,s=new App.Views.Carts;i.fetch({success:e,error:t})},login:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1});var e=new App.Models.Forms.Login,t=new App.Views.Forms.Login({model:e});App.Helpers.renderContent(t.render().el)},logout:function(){this.navigate("",{trigger:!0,replace:!0})},signin:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1});var e=new App.Models.Forms.Sigin,t=new App.Views.Forms.Sigin({model:e});App.Helpers.renderContent(t.render().el)},recover:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1});var e=new App.Models.Forms.Recover,t=new App.Views.Forms.Recover({model:e});App.Helpers.renderContent(t.render().el)},addMedia:function(){}}),new App.Views.Wrapper({model:new App.Models.Layout}),new App.Router,Backbone.history.start();