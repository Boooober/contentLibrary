"use strict";var App={debug:!1,Vent:{},Helpers:{},createForm:function(e,t){return this.create(e,"form",t)},createLayout:function(e,t){return this.create(e,"layout",t)},createContent:function(e,t){return this.create(e,"content",t)},createWidget:function(e){return this.create("view/"+e,"widget")},getLayout:function(){return this.getStateParam("layout")},getQuery:function(){return this.getStateParam("query")},setQuery:function(e){this.setStateParam("query",e)},getUser:function(){return this.getStateParam("user")},setUser:function(e){this.setStateParam("user",e)},getRouter:function(){return this.getStateParam("router")},getStateParam:function(e){return this.get("state").get(e)},setStateParam:function(e,t){return this.get("state").set(e,t)},create:function(){var e,t=[].slice.call(arguments);return 2===t.length&&_.isObject(t[1])&&t.splice(1,0,void 0),(e=this.get.apply(this,t))?(App.debug&&console.log("New instance of "+this.getNamespace(t[0],t[1]).join("/")+" successfully created"),new e(t[2])):void(App.debug&&console.log("No objects found at "+this.getNamespace(t[0],t[1]).join("/")+"."))},get:function(){var e,t,i=[].slice.call(arguments);e=this.getNamespace(i[0],i[1]);try{if(t=function o(t,i){return e[i+1]?o(t[e[i]],++i):t[e[i]]}(this,0))return t;App.debug&&console.log("Path is correct, but object is missing... "+e.join("/"))}catch(n){App.debug&&console.log("No objects at "+e.join("/")+" exists")}},set:function(){var e,t,i=[].slice.call(arguments);return 2===i.length&&_.isObject(i[1])&&i.splice(1,0,void 0),e=this.getNamespace(i[0],i[1]),function n(o,s){return t=e[s],e[s+1]?o[t]?n(o[t],++s):n(o[t]={},++s):o[t]?"Object is already exists.":o[t]=i[2]}(this,0)},getNamespace:function(e,t){var i,n,o=e.split("/");for(t&&(1!==t.search("/")?o.splice(1,0,t):o.splice(1,0,this.getNamespace(t))),i=0,n=o.length;i<n-1;i++)o[i]=o[i].replace(/([^s])$/,"$1s");return o=_.map(o,function(e){return e[0].toUpperCase()+e.slice(1)})}};_.extend(App.Vent,Backbone.Events),App.Helpers={renderContent:function(e){$(".main-content").html($('<div class="container-fluid" />').html(e))},getTemplate:function(e){return _.template($(e).html())},elemToString:function(e){var t=$("<div />").html(e);return t.html()},loadFromCollection:function(e){function t(e){var t;o?(e.reset(e.filter(o)),App.Vent.trigger("collectionLoad",e)):s?(t=e.findWhere(s),t&&App.Vent.trigger("modelLoad",t)):App.Vent.trigger("collectionLoad",e)}function i(e,t){console.log(t.responseText)}var n=e.collection,o=e.filter,s=e.find;n.fetch({success:t,error:i})},getQueryParam:function(e,t){var i,n,o,s;if(t=t||window.location.search.substring(1),!t)return"";for(i=t.search("&")!==-1?t.split("&"):t.split("; "),n=0,o=i.length;n<o;n++)if(s=i[n].split("="),new RegExp(e,"i").test(s[0]))return s[1];return""},storage:function(){var e,t=function(){try{return localStorage.setItem("hello","world"),localStorage.removeItem("hello"),!0}catch(e){return!1}}();return e=t?{set:function(e,t){return 2===arguments.length&&(localStorage[e]=JSON.stringify(t),!0)},get:function(e){if(1===arguments.length){var t=localStorage[e];return t?JSON.parse(t):t}},remove:function(e){localStorage.removeItem(e)}}:{set:function(e,t){if(2!==arguments.length)return!1;var i=new Date((new Date).getTime()+2592e6);return document.cookie=e+"="+JSON.stringify(t)+"; path=/; expires="+i.toUTCString(),!0},get:function(e){if(1===arguments.length){var t=App.Helpers.getQueryParam(e,document.cookie);return t?JSON.parse(t):t}},remove:function(e){document.cookie=e+"=; path=/; expires="+(new Date).toUTCString()}}}()},App.set("model/User",Backbone.Model.extend({defaults:{avatar:"",fullname:"",username:""}})),App.set("model/BaseForm","form",Backbone.Model.extend({})),App.set("model/Contact","form",App.get("model/BaseForm","form").extend({defaults:{name:"",email:"",message:""},response:"",send:function(){console.log("Sending to server... Fake timeout 2s.",this.toJSON()),setTimeout(_.bind(function(){"error"===this.get("message")?(this.response="Some error occures while sending your message. Please, try again later",this.set("success",!1)):(this.response="Your message was successfully sent. We will contact you shortly",this.set("success",!0))},this),2e3)}})),App.set("model/Login","form",App.get("model/BaseForm","form").extend({defaults:{username:"",password:""},login:function(){function e(e){var t=e.findWhere(i);t?App.Vent.trigger("loginSuccess",t):App.Vent.trigger("loginFailed")}function t(e,t){console.log(t.responseText)}var i=this.toJSON(),n=App.create("collection/Users");n.fetch({success:e,error:t})}})),App.set("model/Recover","form",App.get("model/BaseForm","form").extend({defaults:{email:""},validate:function(e){},recover:function(){}})),App.set("model/Signin","form",App.get("model/BaseForm","form").extend({defaults:{login:"",email:"",password:"",password2:""},validate:function(e){},signin:function(){}})),App.set("model/Cart","content",Backbone.Model.extend({defaults:{type:0,title:"",description:"",author:"",mediaLink:"",favorites:0,isFavorite:!1},favoriteToggle:function(){var e=this.get("favorites"),t=this.get("isFavorite");this.set("isFavorite",!t),this.set("favorites",t?--e:++e)},isImage:function(){return 0===this.get("type")},isVideo:function(){return 1===this.get("type")},isText:function(){return 2===this.get("type")}})),App.set("model/Main","layout",Backbone.Model.extend({storage:App.Helpers.storage,initialize:function(){this.set(this.loadOptions()),this.listenTo(App.Vent,"layoutChange",this.change)},loadOptions:function(){var e,t={withSidebar:!1,sidebarCollapsed:!1};return e=_.defaults(this.storage.get("layout")||{},t),e.withSidebar=!!App.getUser(),e},change:function(e){e=e||this.loadOptions(),this.set(e)},update:function(e){this.change(e),this.storage.set("layout",this.toJSON())},withSidebar:function(){return this.get("withSidebar")},sidebarCollapsed:function(){return this.get("sidebarCollapsed")},toggleSidebar:function(){this.update({sidebarCollapsed:!this.get("sidebarCollapsed")}),setTimeout(function(){App.Vent.trigger("layoutResize")},400)},menuItems:function(){var e=[["Home","#",{"in":1,out:1}],["Contacts","#!/contacts",{"in":1,out:1}],["Sign in","#!/account/signin",{"in":0,out:1}],['Log in <i class="icon-login"></i>',"#!/account/login",{"in":0,out:1}],['Log out <i class="icon-logout"></i>',"#!/account/logout",{"in":1,out:0}]],t=[],i=App.getUser()?"in":"out";return $.each(e,function(e,n){n[2][i]&&t.push(App.Helpers.elemToString($("<a />").attr("href",n[1]).html(n[0])))}),t}})),App.set("model/GoogleMap","widget",Backbone.Model.extend({defaults:{lat:50.432014,lng:30.486093,zoom:18,scrollwheel:!1,styles:[{featureType:"water",elementType:"geometry",stylers:[{color:"#e9e9e9"},{lightness:17}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:20}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{lightness:17}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#ffffff"},{lightness:29},{weight:.2}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:18}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:16}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:21}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#dedede"},{lightness:21}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#ffffff"},{lightness:16}]},{elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#333333"},{lightness:40}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#f2f2f2"},{lightness:19}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#fefefe"},{lightness:20}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#fefefe"},{lightness:17},{weight:1.2}]}],markers:[{lat:50.432014,lng:30.486093,title:"Epam office!"}]}})),App.set("collection/Carts",Backbone.Collection.extend({url:"assets/js/database/carts.json",model:App.get("model/Cart","content")})),App.set("collection/Users",Backbone.Collection.extend({url:"assets/js/database/users.json",model:App.get("model/User")})),App.set("view/BaseView",Backbone.View.extend({assign:function(e,t){var i;_.isObject(e)?i=e:(i={},i[e]=t),i&&_.each(i,function(e,t){e.setElement(this.$(t)).render()},this)},remove:function(){this.subviews&&_.each(this.subviews,function(e){e.remove()}),Backbone.View.prototype.remove.call(this)}})),App.set("view/Validator","form",Backbone.View.extend({events:{"submit form":"submitForm","blur input[name]":"validateHandler"},submitForm:function(e){e.preventDefault();var t,i=$(e.target),n=!0,o=this.processData(i.find(":input[name]"));n=_.reduce(o,function(e,t){var i=this.validateOne(t);return e===!0?i:e},n,this),t=_.reduce(o,function(e,t,i){return(t.value||0===t.value)&&(e[i]=t.value),e},{}),n&&this.submit&&this.submit.call(this,e,t)},processData:function(e){var t,i,n={};return _.each(e,function(e){i=$(e),t={$target:i,value:i.val().trim()},n[i.attr("name")]=t}),n},validateHandler:function(e){var t=this.processData($(e.target));_.each(t,this.validateOne,this)},validateOne:function(e){var t,i,n=e.$target,o=e.value,s=n.data("validate")||{};return s.type=n.attr("type")||"text",s.required=!!n.attr("required"),s.pattern=n.attr("pattern"),"number"===s.type&&($.isNumeric(s.min)||$.isNumeric(s.max))&&(s.numMin=s.min,s.numMax=s.max,s.min=s.max=void 0),t=_.every(s,function(e,t){return 0!==e&&e&&("type"===t&&(t=e),this.validators[t]&&(i=this.validators[t].call(this,e,o))),!i},this),this.toggleError(n,i),t},validators:{min:function(e,t){if(!(t.length>=e))return"Value length must be greater than "+e+" symbols."},max:function(e,t){if(!(t.length<=e))return"Value length must be less than "+e+" symbols."},numMin:function(e,t){if(!(t>=e))return"Number must be greater than "+e+"."},numMax:function(e,t){if(!(t<=e))return"Number must be less than "+e+"."},required:function(e,t){if(0===t.length)return"Field value is required"},email:function(e,t){var i=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;if(!i.test(t))return"Incorrect email format"},number:function(e,t){if(!$.isNumeric(t))return"Field value must be numeric"},equals:function(e,t){var i=$(e),n=i.attr("placeholder")||$("label[for='"+i.attr("id")+'"]').html();if(i.val()!==t)return"Field value must match "+n},pattern:function(e,t){if(!new RegExp(e).test(t))return"Field value malformed"}},toggleError:function(e,t){var i=e.next(),n=e.closest(".form-group"),o=t?$('<span class="help-block">'+t+"</span>"):"";t?(n.addClass("has-error").removeClass("has-success"),0!==i.length?i.replaceWith(o):e.after(o)):(n.addClass("has-success").removeClass("has-error"),i&&i.remove())}})),App.set("view/BaseForm","form",App.get("view/Validator","form").extend({clearInputs:function(){this.$(":input[name]").each(function(){$(this).val("")})},extendParentEvents:function(e){this.events=_.extend(App.get("view/Validator","form").prototype.events,e)}})),App.set("view/AccountDestroy","form",App.get("view/BaseForm","form").extend({template:App.Helpers.getTemplate("#profileDestroy"),events:{"click button":"submit"},initialize:function(){this.model=App.getUser()},render:function(){return this.setElement(this.template(this.model.toJSON())),this},submit:function(e){var t=$(e.target);t.hasClass("destroy")&&App.Vent.trigger("userLogout"),App.Vent.trigger("closePopup",this)}})),App.set("view/AccountEdit","form",App.get("view/BaseForm","form").extend({template:App.Helpers.getTemplate("#profileEdit"),events:{"change .account-avatar":"loadImage"},initialize:function(){this.model=App.getUser(),this.extendParentEvents(this.events)},render:function(){return this.setElement(this.template(this.model.toJSON())),this},loadImage:function(e){var t=$(e.target),i=t.prop("files")[0],n=new FileReader;i&&(n.onload=function(e){this.$("img").attr("src",e.target.result)}.bind(this),n.readAsDataURL(i))},submit:function(e,t){this.model.set(t),App.Vent.trigger("closePopup",this)}})),App.set("view/AddCart","form",App.get("view/BaseForm","form").extend({template:App.Helpers.getTemplate("#addCart"),initialize:function(){this.model=this.model?this.model:App.createContent("model/Cart"),this.extendParentEvents(this.events)},events:{},render:function(){return this.setElement(this.template(this.model.toJSON())),this},submit:function(e,t){this.model.set(t),App.Vent.trigger("closePopup",this)}})),App.set("view/Contact","form",App.get("view/BaseForm","form").extend({initialize:function(){this.model=App.createForm("model/Contact"),this.listenTo(this.model,"change:success",this.showResponse)},template:App.Helpers.getTemplate("#contactForm"),render:function(){return this.$el.html(this.template()),this},submit:function(e,t){this.model.set(t),this.model.send()},showResponse:function(){App.createWidget("Popup").render(this.model.response,{toggle:!1,trigger:!1}),this.model.get("success")&&this.clearInputs(),this.model.clear({silent:!0})}})),App.set("view/Login","form",App.get("view/BaseForm","form").extend({initialize:function(){this.listenTo(App.Vent,"loginFailed",this.showFail)},template:App.Helpers.getTemplate("#loginForm"),render:function(){return this.setElement(this.template()),this},submit:function(e,t){this.model.set(t),this.model.login()},showFail:function(){console.log("login attempt failed")}})),App.set("view/Recover","form",App.get("view/BaseForm","form").extend({initialize:function(){},template:App.Helpers.getTemplate("#recoverForm"),render:function(){return this.setElement(this.template()),this}})),App.set("view/Search","form",Backbone.View.extend({events:{"submit form":"submit","keyup [name='s']":"keyup"},template:App.Helpers.getTemplate("#searchform"),render:function(){return this.$el.html(this.template()),this},keyup:function(e){var t=$(e.target).val();t.length>2&&this.search(t)},submit:function(e){e.preventDefault();var t=$(e.target).find("input[name='s']").val();this.search(t)},search:function(e){var t=App.getRouter();e.length>0?t.navigate("!/search/"+e,{trigger:!0}):t.navigate("",{trigger:!0})}})),App.set("view/Sigin","form",App.get("view/BaseForm","form").extend({initialize:function(){},template:App.Helpers.getTemplate("#signinForm"),render:function(){return this.setElement(this.template()),this},submit:function(e){console.log("Form is submitting")}})),App.set("view/AccountInfo","content",App.get("view/BaseView").extend({template:App.Helpers.getTemplate("#accountInfo"),events:{"click .account-dropdown a[href='#!/account/edit']":"edit","click .account-dropdown a[href='#!/account/destroy']":"destroy"},initialize:function(){this.model=App.getUser(),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},edit:function(e){e.preventDefault();var t=$(e.target),i=t.attr("href").substr(1),n=Backbone.history.getFragment();App.getRouter().navigate(i),App.createWidget("Popup").render(App.createForm("view/AccountEdit"),{redirect:function(){App.getRouter().navigate(n)}})},destroy:function(e){e.preventDefault();var t=$(e.target),i=t.attr("href").substr(1),n=Backbone.history.getFragment();App.getRouter().navigate(i),App.createWidget("Popup").render(App.createForm("view/AccountDestroy"),{redirect:function(){App.getRouter().navigate(n)},size:"sm"})}})),App.set("view/BaseCart","content",App.get("view/BaseView").extend({scaleMedia:function(){var e=this.$(".video-cart iframe"),t=e.parent(),i=function(){var i=t.width()/e.attr("width"),n=e.attr("height")*i;t.css("padding-bottom",n)}.bind(this);setTimeout(i,0),$(window).resize(i),this.listenTo(App.Vent,"layoutResize",i)},processMediaTag:function(e,t){var i;return this.model.isVideo()?i=$("<iframe />").attr({width:640,height:360,src:e,frameborder:0,allowfullscreen:!0}):this.model.isImage()&&(i=$("<img />").attr({src:e,alt:t,title:t})),App.Helpers.elemToString(i)},typeClass:function(){return this.model.isImage()?"image-cart":this.model.isVideo()?"video-cart":"text-type"},getLink:function(e){var t=$("<a />").attr({href:"#!/page/"+this.model.id,"class":e});return App.Helpers.elemToString(t)},socialLinks:function(){return[]}})),App.set("view/CartToolbox","content",App.get("view/BaseView").extend({initialize:function(){this.model.on("change:favorites",this.render,this)},events:{"click .rate-button":"toggleRate"},template:App.Helpers.getTemplate("#cartToolbox"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggleRate:function(e){e.preventDefault(),this.model.favoriteToggle()}})),App.set("view/Cart","content",App.get("view/BaseCart","content").extend({initSubviews:function(){return this.subviews={},this.subviews[".toolbox"]=App.createContent("view/CartToolbox",{model:this.model}),this.subviews},events:{"click .post-link":"openInPopup"},mediaTemplate:App.Helpers.getTemplate("#mediaCart"),textTemplate:App.Helpers.getTemplate("#textCart"),render:function(){var e=this.model.isText()?"text":"media",t=this[e+"Template"](this.model.toJSON());return this.setElement(t),this.assign(this.initSubviews()),this.model.isVideo()&&this.scaleMedia(),this},openInPopup:function(e){e.preventDefault();var t=this.model.get("id"),i=App.getRouter(),n=App.createContent("view/CartInPopup",{model:this.model});i.navigate("!/page/"+t),App.createWidget("Popup").render(n,{redirect:function(){i.navigate("")}})}})),App.set("view/CartInPopup","content",App.get("view/BaseCart","content").extend({template:App.Helpers.getTemplate("#cartInPopup"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this.model.isVideo()&&this.scaleMedia(),this}})),App.set("view/CartPage","layout",App.get("view/BaseCart","content").extend({className:"container-fluid",template:App.Helpers.getTemplate("#cartPage"),initialize:function(){this.listenTo(App.Vent,"modelLoad",this.render)},render:function(e){return this.model=e,this.$el.html(this.template(e.toJSON())),App.Helpers.renderContent(this.el),this}})),App.set("view/Carts","layout",App.get("view/BaseView").extend({className:"row",subviews:{},initialize:function(){this.listenTo(App.Vent,"collectionLoad",this.renderCollection)},renderCollection:function(e){this.collection=e,this.render()},render:function(){return this.$el.html(""),this.collection.each(this.addOne,this),App.Helpers.renderContent(this.$el),this.masonry(),this},addOne:function(e,t){var i=App.create("view/Cart","content",{model:e});this.subviews[t]=i,this.$el.append(i.render().el)},masonry:function(){var e=this.$("iframe, img, video"),t=e.length,i=0,n=function(){this.$el.masonry({columnWidth:this.$(".cart-item")[0],itemSelector:".cart-item",percentPosition:!0})}.bind(this);e.load(function(){++i<t||n()}),this.listenTo(App.Vent,"layoutResize",n)}})),App.set("view/Contacts","layout",App.get("view/BaseView").extend({template:App.Helpers.getTemplate("#contactPage"),initSubviews:function(){return this.subviews={".contact-form":App.createForm("view/Contact",App.createForm("model/Contact")),".google-map":App.create("view/GoogleMap","widget")},this.subviews},render:function(){return this.setElement(this.template()),this.assign(this.initSubviews()),App.Helpers.renderContent(this.el),this}})),App.set("view/Topmenu","layout",App.get("view/BaseView").extend({template:App.Helpers.getTemplate("#topMenu"),initialize:function(){this.model=App.getLayout(),this.listenTo(this.model,"change:withSidebar",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.assign(this.initSubviews()),this},initSubviews:function(){return this.subviews={},this.subviews[".searchform"]=App.createForm("view/Search"),this.subviews}})),App.set("view/Sidebar","layout",App.get("view/BaseView").extend({template:App.Helpers.getTemplate("#sidebarLayout"),initSubviews:function(){return this.subviews={},this.subviews[".account-info"]=App.createContent("view/AccountInfo"),this.subviews},initialize:function(){this.model=App.getLayout(),this.listenTo(this.model,"change:sidebarCollapsed",this.toggleSidebar)},render:function(){return this.setElement(this.template()),this.assign(this.initSubviews()),this.$(".side-wrapper").slimScroll({height:"100%"}),this},toggleSidebar:function(){this.model.sidebarCollapsed()?this.$(".side-content").fadeOut(150):this.$(".side-content").hide().delay(300).fadeIn(150)}})),App.set("view/MainContent","layout",App.get("view/BaseView").extend({events:{"click .sidebar-toggle":"toggleSidebar"},template:App.Helpers.getTemplate("#pageLayout"),initialize:function(){this.model=App.getLayout()},render:function(){return this.setElement(this.template()),this.assign(this.initSubviews()),this},initSubviews:function(){return this.subviews={},this.subviews[".topmenu"]=App.createLayout("view/Topmenu"),this.subviews},toggleSidebar:function(e){e.preventDefault(),this.model.toggleSidebar()}})),App.set("view/Wrapper","layout",App.get("view/BaseView").extend({el:"#wrapper",template:App.Helpers.getTemplate("#wrapperAppends"),initialize:function(){this.model=App.getLayout(),this.listenTo(App.Vent,"layoutRender",this.render),this.listenTo(this.model,"change:withSidebar",this.reset),this.listenTo(this.model,"change:sidebarCollapsed",this.toggleSidebar)},render:function(){this.initSubviews(),_.each(this.subviews,function(e){this.$el.append(e.render().el)},this),this.$el.append(this.template())},initSubviews:function(){this.subviews=[],this.model.withSidebar()&&(this.$el.addClass("with-sidebar"),this.subviews.push(App.createLayout("view/Sidebar")),this.model.sidebarCollapsed()&&this.$el.addClass("sidebar-collapsed")),this.subviews.push(App.createLayout("view/MainContent"))},toggleSidebar:function(e,t){t?this.$el.addClass("sidebar-collapsed"):this.$el.removeClass("sidebar-collapsed")},reset:function(){_.each(this.subviews,function(e){e.remove()}),this.$el.html("").removeClass(),this.render()}})),App.set("view/GoogleMap","widget",Backbone.View.extend({initialize:function(){this.model=App.create("model/GoogleMap","widget")},apiKey:"",render:function(){window.google&&window.google&&window.google.maps?this.renderMap():$.getScript("//maps.googleapis.com/maps/api/js?key="+this.apiKey,_.bind(this.renderMap,this))},renderMap:function(){var e,t=new google.maps.LatLng(this.model.get("lat"),this.model.get("lng"));e={center:t,zoom:this.model.get("zoom"),styles:this.model.get("styles"),scrollwheel:this.model.get("scrollwheel")},this.map||(this.map=new google.maps.Map(this.el,e),_.each(this.model.get("markers"),function(e){new google.maps.Marker({position:new google.maps.LatLng(e.lat,e.lng),map:this.map,title:e.title})},this))}})),App.set("view/Popup","widget",Backbone.View.extend({className:"popup",initialize:function(){this.root=$(document).find(".popup-container");var e=$('<div class="popup-table" />'),t=$('<div class="popup-cell" />'),i=$('<div class="popup-content" />');this.$el.html(e.html(t.html(i))),this.$content=i,this.listenTo(App.Vent,"closePopup",this.closeVent)},events:{"click .close-trigger, .popup-cell":"closeHandler"},sizes:{sm:"popup-sm",md:"popup-md"},defaultOptions:{toggle:!1,toggleDelay:4e3,trigger:!0,size:"md",className:"popup-bg-default",css:{},removeTimeout:500,redirect:function(){}},render:function(e,t){var i=this.getDataContent(e);this.$el.css("z-index",9999),this.$content.html(i),this.setOptions(t),this.open()},setOptions:function(e){e=_.defaults(e||{},this.defaultOptions),_.each(e,function(t,i){switch(i){case"toggle":t===!0&&(App.debug&&console.log("popup will close in "+e.toggleDelay+" ms"),this.$el.data("timeout",setTimeout(_.bind(this.close,this),e.toggleDelay)));break;case"trigger":t===!0&&this.$content.append('<div class="close-trigger" />');break;case"size":this.$el.addClass(this.sizes[t]);break;case"className":this.$el.addClass(t);break;case"css":this.$el.css(t);break;default:this[i]=t}},this)},closeHandler:function(e){e.target===e.currentTarget&&this.close()},closeVent:function(e){this.nestedView&&this.nestedView.cid===e.cid&&this.close()},open:function(){this.root.append(this.$el),this.$el.fadeIn().addClass("open--popup")},close:function(){var e=this.$el.data("timeout");void 0!==e&&clearTimeout(e),this.$el.toggleClass("open--popup close--popup"),setTimeout(_.bind(this.removePopup,this),this.removeTimeout)},removePopup:function(){this.removeNestedView(),this.redirect(),this.remove()},getDataContent:function(e){return e instanceof Backbone.View?(this.nestedView=e,e.render().el):e},removeNestedView:function(){this.nestedView&&this.nestedView.remove()}})),App.Router=Backbone.Router.extend({routes:{"":"index","!/":"index","!/account/signin":"accountSignin","!/account/login":"accountLogin","!/account/logout":"accountLogout","!/account/recover":"accountRecover","!/account/destroy":"accountDestroy","!/account/edit":"accountEdit","!/contacts":"contacts","!/page/:id":"page","!/search/:s":"search","!/uploads":"uploads","!/favorites":"favorites","!/add-cart":"addCart"},execute:function(e,t){this.view&&this.view.remove(),e&&e.apply(this,t)},index:function(){App.Vent.trigger("layoutChange"),this.view=App.createLayout("view/Carts"),App.Helpers.loadFromCollection({collection:App.create("collection/Carts")})},accountLogin:function(){App.Vent.trigger("layoutChange",{sidebarCollapsed:!0}),this.view=App.createForm("view/Login",{model:App.createForm("model/Login")}),App.Helpers.renderContent(this.view.render().el)},accountLogout:function(){App.Vent.trigger("userLogout"),this.navigate("",{trigger:!0,replace:!0})},accountSignin:function(){App.Vent.trigger("layoutChange",{sidebarCollapsed:!0}),this.view=App.createForm("view/Sigin",{model:App.createForm("model/Sigin")}),App.Helpers.renderContent(this.view.render().el)},accountRecover:function(){App.Vent.trigger("layoutChange",{sidebarCollapsed:!0}),this.view=App.createForm("view/Recover",{model:App.createForm("model/Recover")}),App.Helpers.renderContent(this.view.render().el)},accountEdit:function(){App.Vent.trigger("layoutChange"),this.view=App.createForm("view/AccountEdit"),App.Helpers.renderContent(this.view.render().el)},accountDestroy:function(){},contacts:function(){App.Vent.trigger("layoutChange",{sidebarCollapsed:!0}),this.view=App.createLayout("view/Contacts").render()},search:function(e){App.Vent.trigger("layoutChange"),this.view=App.createLayout("view/Carts"),App.Helpers.loadFromCollection({collection:App.create("collection/Carts"),filter:function(){var t=new RegExp(e,"i");return function(e){return t.test(e.get("title"))||t.test(e.get("description"))}}()})},page:function(e){App.Vent.trigger("layoutChange"),this.view=App.createLayout("view/CartPage"),App.Helpers.loadFromCollection({collection:App.create("collection/Carts"),find:{id:parseInt(e)}})},addCart:function(){console.log("final route")},uploads:function(){App.Vent.trigger("layoutChange"),this.view=App.createLayout("view/Carts"),App.Helpers.loadFromCollection({collection:App.create("collection/Carts"),filter:function(){var e=new RegExp(App.getUser().get("fullname"),"i");return function(t){return e.test(t.get("author"))}}()})},favorites:function(){App.Vent.trigger("layoutChange"),this.view=App.createLayout("view/Carts"),App.Helpers.loadFromCollection({collection:App.create("collection/Carts"),filter:function(e){return e.get("isFavorite")}})}}),App.State=new(Backbone.Model.extend({storage:App.Helpers.storage,defaults:{user:{},router:{},layout:{},query:{}},initialize:function(){this.listenTo(App.Vent,"loginSuccess",this.userLogin),this.listenTo(App.Vent,"userLogout",this.userLogout)},userLogin:function(e){this.set("user",e),this.storage.set("userId",e.id),App.getRouter().navigate("",{trigger:!0})},userLogout:function(){this.set("user",!1),this.storage.remove("userId"),this.storage.remove("layout"),App.getRouter().navigate("",{trigger:!0,replace:!0})},run:function(){var e=this,t=this.storage.get("userId");return t?void App.create("collection/Users").fetch({success:function(i){var n=i.get(t);n&&e.set("user",n),e.draw()},error:function(e,t){console.log(t.responseText)}}):(this.set("user",!1),void this.draw())},draw:function(){this.set("layout",App.create("model/Main","layout")),App.create("view/Wrapper","layout"),App.Vent.trigger("layoutRender"),this.set("router",new App.Router),Backbone.history.start()}})),App.State.run(),+function(e){function t(t){var i=t.attr("data-target");i||(i=t.attr("href"),i=i&&/#[A-Za-z]/.test(i)&&i.replace(/.*(?=#[^\s]*$)/,""));var n=i&&e(i);return n&&n.length?n:t.parent()}function i(i){i&&3===i.which||(e(o).remove(),e(s).each(function(){var n=e(this),o=t(n),s={relatedTarget:this};o.hasClass("open")&&(i&&"click"==i.type&&/input|textarea/i.test(i.target.tagName)&&e.contains(o[0],i.target)||(o.trigger(i=e.Event("hide.bs.dropdown",s)),i.isDefaultPrevented()||(n.attr("aria-expanded","false"),o.removeClass("open").trigger(e.Event("hidden.bs.dropdown",s)))))}))}function n(t){return this.each(function(){var i=e(this),n=i.data("bs.dropdown");n||i.data("bs.dropdown",n=new r(this)),"string"==typeof t&&n[t].call(i)})}var o=".dropdown-backdrop",s='[data-toggle="dropdown"]',r=function(t){e(t).on("click.bs.dropdown",this.toggle)};r.VERSION="3.3.7",r.prototype.toggle=function(n){var o=e(this);if(!o.is(".disabled, :disabled")){var s=t(o),r=s.hasClass("open");if(i(),!r){"ontouchstart"in document.documentElement&&!s.closest(".navbar-nav").length&&e(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(e(this)).on("click",i);var a={relatedTarget:this};if(s.trigger(n=e.Event("show.bs.dropdown",a)),n.isDefaultPrevented())return;o.trigger("focus").attr("aria-expanded","true"),s.toggleClass("open").trigger(e.Event("shown.bs.dropdown",a))}return!1}},r.prototype.keydown=function(i){if(/(38|40|27|32)/.test(i.which)&&!/input|textarea/i.test(i.target.tagName)){var n=e(this);if(i.preventDefault(),i.stopPropagation(),!n.is(".disabled, :disabled")){var o=t(n),r=o.hasClass("open");if(!r&&27!=i.which||r&&27==i.which)return 27==i.which&&o.find(s).trigger("focus"),n.trigger("click");var a=" li:not(.disabled):visible a",l=o.find(".dropdown-menu"+a);if(l.length){var p=l.index(i.target);38==i.which&&p>0&&p--,40==i.which&&p<l.length-1&&p++,~p||(p=0),l.eq(p).trigger("focus")}}}};var a=e.fn.dropdown;e.fn.dropdown=n,e.fn.dropdown.Constructor=r,e.fn.dropdown.noConflict=function(){return e.fn.dropdown=a,this},e(document).on("click.bs.dropdown.data-api",i).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",s,r.prototype.toggle).on("keydown.bs.dropdown.data-api",s,r.prototype.keydown).on("keydown.bs.dropdown.data-api",".dropdown-menu",r.prototype.keydown)}(jQuery);