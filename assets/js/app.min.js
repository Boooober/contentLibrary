"use strict";var debug=!0,App={Vent:{},Helpers:{},createForm:function(e,t){return this.create(e,"form",t)},createLayout:function(e,t){return this.create(e,"layout",t)},createContent:function(e,t){return this.create(e,"content",t)},create:function(){var e,t=[].slice.call(arguments);return 2===t.length&&_.isObject(t[1])&&t.splice(1,0,void 0),(e=this.get.apply(this,t))?(debug&&console.log("New instance of "+this.getNamespace(t[0],t[1]).join("/")+" successfully created"),new e(t[2])):void(debug&&console.log("No objects found at "+this.getNamespace(t[0],t[1]).join("/")+"."))},get:function(){var e,t,i=[].slice.call(arguments);e=this.getNamespace(i[0],i[1]);try{if(t=function n(t,i){return e[i+1]?n(t[e[i]],++i):t[e[i]]}(this,0))return t;debug&&console.log("Path is correct, but object is missing... "+e.join("/"))}catch(s){debug&&console.log("No objects at "+e.join("/")+" exists")}},set:function(){var e,t,i=[].slice.call(arguments);return 2===i.length&&_.isObject(i[1])&&i.splice(1,0,void 0),e=this.getNamespace(i[0],i[1]),function s(n,o){return t=e[o],e[o+1]?n[t]?s(n[t],++o):s(n[t]={},++o):n[t]?"Object is already exists.":n[t]=i[2]}(this,0)},getNamespace:function(e,t){var i,s,n=e.split("/");for(t&&(1!==t.search("/")?n.splice(1,0,t):n.splice(1,0,this.getNamespace(t))),i=0,s=n.length;i<s-1;i++)n[i]=n[i].replace(/([^s])$/,"$1s");return n=_.map(n,function(e){return e[0].toUpperCase()+e.slice(1)})}};_.extend(App.Vent,Backbone.Events),App.Helpers={renderContent:function(e){$(".main-content").html(e)},getTemplate:function(e){return _.template($(e).html())},getTypeTemplate:function(e){return this.getTemplate("#"+e+"Cart")},getQueryParam:function(e,t){var i,s,n,o;if(t=t||window.location.search.substring(1),!t)return"";for(i=t.search("&")!==-1?t.split("&"):t.split("; "),s=0,n=i.length;s<n;s++)if(o=i[s].split("="),new RegExp(e,"i").test(o[0]))return o[1];return""},storage:function(e){return function(){function t(){var t,i;switch(arguments.length){case 1:t=e,i=JSON.stringify(arguments[0]);break;case 2:t=arguments[0],i=JSON.stringify(arguments[1]);break;default:return!1}return{name:t,value:i}}var i,s=function(){try{return localStorage.setItem("test","hello"),localStorage.removeItem("test"),!0}catch(e){return!1}}();return i=s?{set:function(){var e=t.apply(this,arguments);return!!e&&(localStorage[e.name]=e.value,!0)},get:function(t){return t=t||e,JSON.parse(localStorage[t]||"{}")}}:{set:function(){var e=t.apply(this,arguments),i=new Date((new Date).getTime()+2592e6);return!!e&&(document.cookie=e.name+"="+e.value+"; path=/; expires="+i.toUTCString(),!0)},get:function(t){return t=t||e,JSON.parse(App.Helpers.getQueryParam(t,document.cookie)||"{}")}}}()}},App.set("model/BaseForm","form",Backbone.Model.extend({})),App.set("model/Contact","form",App.get("model/BaseForm","form").extend({defaults:{name:"",email:"",message:""},validate:function(e){console.log(e)},login:function(e){this.set(e),this.isValid()||console.log(this.validationError)}})),App.set("model/Login","form",App.get("model/BaseForm","form").extend({defaults:{login:"",password:""},validate:function(e){console.log(e)},login:function(e){this.set(e),this.isValid()||console.log(this.validationError)}})),App.set("model/Recover","form",App.get("model/BaseForm","form").extend({defaults:{email:""},validate:function(e){},recover:function(){}})),App.set("model/Search","form",Backbone.Model.extend({defaults:{s:App.Helpers.getQueryParam("s")},search:function(e){var t=App.create("collection/Carts");this.set("s",e),t.fetch({success:function(){var i;e&&(i=new RegExp(e,"i"),t.reset(t.filter(function(e){return i.test(e.get("title"))||i.test(e.get("description"))}))),App.Vent.trigger("collectionLoad",t)}})}})),App.set("model/Signin","form",App.get("model/BaseForm","form").extend({defaults:{login:"",email:"",password:"",password2:""},validate:function(e){},signin:function(){}})),App.set("model/Cart","content",Backbone.Model.extend({defaults:{type:0,title:"",description:"",author:"",mediaLink:"",favorites:0,isFavorite:!1},favoriteToggle:function(){var e=this.get("favorites"),t=this.get("isFavorite");this.set("isFavorite",!t),this.set("favorites",t?--e:++e)},isImage:function(){return 0===this.get("type")},isVideo:function(){return 1===this.get("type")},isText:function(){return 2===this.get("type")}})),App.set("model/Main","layout",Backbone.Model.extend({storage:App.Helpers.storage("Layout"),initialize:function(){this.loadOptions(),this.listenTo(App.Vent,"layoutUpdate",this.update),this.listenTo(App.Vent,"layoutUpdateForce",this.updateForce)},defaults:{sidebar:!0,sidebarCollapsed:!0},update:function(e,t){this.updateOptions(e),this.updateForce(e,t)},updateForce:function(e,t){t=!_.isBoolean(t)||t,e&&this.set(e),t&&App.Vent.trigger("layoutRender")},withSidebar:function(){return this.get("sidebar")},sidebarCollapsed:function(){return this.get("sidebarCollapsed")},toggleSidebar:function(){this.update({sidebarCollapsed:!this.get("sidebarCollapsed")},!1),setTimeout(function(){App.Vent.trigger("layoutResize")},400)},loadOptions:function(){this.set(this.storage.get())},saveOptions:function(e){this.set(e),this.storage.set(this.toJSON())},updateOptions:function(e){this.loadOptions(),this.saveOptions(e)}})),App.set("model/GoogleMap","widget",Backbone.Model.extend({defaults:{lat:50.432014,lng:30.486093,zoom:18,scrollwheel:!1,styles:[{featureType:"water",elementType:"geometry",stylers:[{color:"#e9e9e9"},{lightness:17}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:20}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{lightness:17}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#ffffff"},{lightness:29},{weight:.2}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:18}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#ffffff"},{lightness:16}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#f5f5f5"},{lightness:21}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#dedede"},{lightness:21}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#ffffff"},{lightness:16}]},{elementType:"labels.text.fill",stylers:[{saturation:36},{color:"#333333"},{lightness:40}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#f2f2f2"},{lightness:19}]},{featureType:"administrative",elementType:"geometry.fill",stylers:[{color:"#fefefe"},{lightness:20}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#fefefe"},{lightness:17},{weight:1.2}]}],markers:[{lat:50.432014,lng:30.486093,title:"Epam office!"}]}})),App.set("collection/Carts",Backbone.Collection.extend({url:"assets/js/database/carts.json",model:App.get("model/Cart","content")})),App.set("view/BaseView",Backbone.View.extend({assign:function(e,t){var i;_.isObject(e)?i=e:(i={},i[e]=t),i&&_.each(i,function(e,t){e.setElement(this.$(t)).render()},this)}})),App.set("view/BaseForm","form",Backbone.View.extend({events:{"submit form":"submitForm","blur input[name]":"validateInput"},submitForm:function(e){e.preventDefault();var t=$(e.target),i=t.find(":input[name]"),s=!0;s=_.reduce(i,function(e,t){var i=this.validateOne(t);return e===!0?i:e},s,this),s&&this.submit&&this.submit.call(this,e)},validateInput:function(e){return this.validateOne(e.target)},validateOne:function(e){var t,i,s=$(e),n=s.val().trim(),o=s.data("validate")||{};return o.type=s.attr("type")||"text",o.required=!!s.attr("required"),o.pattern=s.attr("pattern"),"number"===o.type&&($.isNumeric(o.min)||$.isNumeric(o.max))&&(o.numMin=o.min,o.numMax=o.max,o.min=o.max=void 0),t=_.every(o,function(e,t){return 0!==e&&e&&("type"===t&&(t=e),this.validators[t]&&(i=this.validators[t].call(this,e,n))),!i},this),this.toggleError(s,i),t},validators:{min:function(e,t){if(!(t.length>=e))return"Value length must be greater than "+e+" symbols."},max:function(e,t){if(!(t.length<=e))return"Value length must be less than "+e+" symbols."},numMin:function(e,t){if(!(t>=e))return"Number must be greater than "+e+"."},numMax:function(e,t){if(!(t<=e))return"Number must be less than "+e+"."},required:function(e,t){if(0===t.length)return"Field value is required"},email:function(e,t){var i=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;if(!i.test(t))return"Incorrect email format"},number:function(e,t){if(!$.isNumeric(t))return"Field value must be numeric"},equals:function(e,t){var i=$(e),s=i.attr("placeholder")||$("label[for='"+i.attr("id")+'"]').html();if(i.val()!==t)return"Field value must match "+s},pattern:function(e,t){if(!new RegExp(e).test(t))return"Field value malformed"}},toggleError:function(e,t){var i=e.next(),s=e.closest(".form-group"),n=t?$('<span class="help-block">'+t+"</span>"):"";t?(s.addClass("has-error").removeClass("has-success"),0!==i.length?i.replaceWith(n):e.after(n)):(s.addClass("has-success").removeClass("has-error"),i&&i.remove())}})),App.set("view/Contact","form",App.get("view/BaseForm","form").extend({initialize:function(){},template:App.Helpers.getTemplate("#contactForm"),successMessage:App.Helpers.getTemplate("#contactFormSuccess"),errorMessage:App.Helpers.getTemplate("#contactFormError"),render:function(){return this.$el.html(this.template()),this},submit:function(){console.log("Contact form is submitting"),App.create("view/Popup","widget").render("Contact form is submitting",{toggle:!0,trigger:!0})}})),App.set("view/Login","form",App.get("view/BaseForm","form").extend({initialize:function(){},template:App.Helpers.getTemplate("#loginForm"),render:function(){return this.setElement(this.template()),this}})),App.set("view/Recover","form",App.get("view/BaseForm","form").extend({initialize:function(){},template:App.Helpers.getTemplate("#recoverForm"),render:function(){return this.setElement(this.template()),this}})),App.set("view/Search","form",Backbone.View.extend({events:{"submit form":"submit","keyup [name='s']":"keyup"},template:App.Helpers.getTemplate("#searchform"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},keyup:function(e){var t=$(e.target).val();t.length>2&&this.search(t)},submit:function(e){e.preventDefault();var t=$(e.target).find("input[name='s']").val();this.search(t)},search:function(e){this.model.search(e)}})),App.set("view/Sigin","form",App.get("view/BaseForm","form").extend({initialize:function(){},template:App.Helpers.getTemplate("#signinForm"),render:function(){return this.setElement(this.template()),this},submit:function(e){console.log("Form is submitting")}})),App.set("view/CartToolbox","content",App.get("view/BaseView").extend({initialize:function(){this.model.on("change:favorites",this.render,this)},events:{"click .rate-button":"toggleRate"},template:App.Helpers.getTemplate("#cartToolbox"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},toggleRate:function(e){e.preventDefault(),this.model.favoriteToggle()}})),App.set("view/Cart","content",App.get("view/BaseView").extend({initSubviews:function(){return this.subviews={},this.subviews[".toolbox"]=App.createContent("view/CartToolbox",{model:this.model}),this.subviews},templates:[App.Helpers.getTypeTemplate("image"),App.Helpers.getTypeTemplate("video"),App.Helpers.getTypeTemplate("text")],render:function(){var e=this.model.toJSON(),t=this.templates[e.type](e);return this.setElement($(t)),this.assign(this.initSubviews()),this.model.isVideo()&&this.scaleMedia(),this},scaleMedia:function(){var e=this.$(".video-frame iframe"),t=e.parent(),i=function(){var i=t.width()/e.attr("width"),s=e.attr("height")*i;t.css("padding-bottom",s)}.bind(this);e.load(i),$(window).resize(i),this.listenTo(App.Vent,"layoutResize",i)}})),App.set("view/Carts","layout",Backbone.View.extend({className:"row",initialize:function(){this.listenTo(App.Vent,"collectionLoad",this.setCollection)},setCollection:function(e){this.collection?this.collection.reset(e.models):(this.collection=e,this.listenTo(this.collection,"reset",this.redraw))},render:function(){return this.collection.each(this.addOne,this),this.masonry(),this},redraw:function(){this.reset().render()},reset:function(){return this.$el.html(""),this},addOne:function(e){var t=App.create("view/Cart","content",{model:e});this.$el.append(t.render().el)},masonry:function(){var e=this.$("iframe, img, video"),t=e.length,i=0,s=function(){this.$el.masonry({columnWidth:this.$(".cart-item")[0],itemSelector:".cart-item",percentPosition:!0})}.bind(this);e.load(function(){++i<t||s()}),this.listenTo(App.Vent,"layoutResize",s)}})),App.set("view/Contacts","layout",App.get("view/BaseView").extend({el:".main-content",template:App.Helpers.getTemplate("#contactPage"),initSubviews:function(){return this.subviews={".contact-form":App.createForm("view/Contact",App.createForm("model/Contact")),".google-map":App.create("view/GoogleMap","widget")},this.subviews},render:function(){return this.$el.html(this.template()),this.assign(this.initSubviews()),this}})),App.set("view/Topmenu","layout",App.Views.BaseView.extend({template:App.Helpers.getTemplate("#topMenu"),render:function(){return this.$el.html(this.template()),this}})),App.set("view/Sidebar","layout",App.Views.BaseView.extend({initialize:function(){this.model.on("change:sidebarCollapsed",this.toggleSidebar,this),this.subviews[".searchform"]=App.createForm("view/Search",{model:App.createForm("model/Search")})},subviews:{},template:App.Helpers.getTemplate("#sidebarLayout"),render:function(){return this.setElement(this.template()),this.assign(this.subviews),this.$(".side-wrapper").slimScroll({height:"100%"}),this},toggleSidebar:function(){this.model.get("sidebarCollapsed")?this.$(".side-content").fadeOut(150):this.$(".side-content").hide().delay(300).fadeIn(150)}})),App.set("view/MainContent","layout",App.Views.BaseView.extend({initialize:function(){this.subviews[".topmenu"]=App.createLayout("view/Topmenu")},events:{"click .sidebar-toggle":"toggleSidebar"},subviews:{},template:App.Helpers.getTemplate("#pageLayout"),render:function(){return this.setElement(this.template()),this.assign(this.subviews),this},toggleSidebar:function(){this.model.toggleSidebar()}})),App.set("view/Wrapper","layout",App.get("view/BaseView").extend({el:"#wrapper",initialize:function(){this.listenTo(App.Vent,"layoutRender",this.render),this.model.on("change:sidebarCollapsed",this.toggleSidebar,this)},initSubviews:function(){this.subviews=[],this.model.withSidebar()&&(this.$el.addClass("with-sidebar"),this.subviews.push(App.createLayout("view/Sidebar",{model:this.model})),this.model.sidebarCollapsed()&&this.$el.addClass("sidebar-collapsed")),this.subviews.push(App.createLayout("view/MainContent",{model:this.model}))},template:App.Helpers.getTemplate("#wrapperAppends"),render:function(){this.$el.html("").removeClass(),this.initSubviews(),_.each(this.subviews,function(e){this.$el.append(e.render().el)},this),this.$el.append(this.template())},toggleSidebar:function(){this.$el.toggleClass("sidebar-collapsed")}})),App.set("view/GoogleMap","widget",Backbone.View.extend({initialize:function(){this.model=App.create("model/GoogleMap","widget")},apiKey:"",render:function(){window.google&&window.google&&window.google.maps?this.renderMap():$.getScript("//maps.googleapis.com/maps/api/js?key="+this.apiKey,_.bind(this.renderMap,this))},renderMap:function(){var e,t=new google.maps.LatLng(this.model.get("lat"),this.model.get("lng"));e={center:t,zoom:this.model.get("zoom"),styles:this.model.get("styles"),scrollwheel:this.model.get("scrollwheel")},this.map||(this.map=new google.maps.Map(this.el,e),_.each(this.model.get("markers"),function(e){new google.maps.Marker({position:new google.maps.LatLng(e.lat,e.lng),map:this.map,title:e.title})},this))}})),App.set("view/Popup","widget",Backbone.View.extend({initialize:function(){this.setElement($(document).find(".popup")),this.initial=this.$el.clone(),this.$container=this.$(".popup-container"),this.$box=$('<div class="popup-box" />')},events:{"click .close-trigger, .popup-container":"closeHandler"},sizes:{sm:"popup-sm",md:"popup-md"},defaultOptions:{toggle:!1,toggleDelay:4e3,trigger:!0,size:"md",className:"",css:{}},render:function(e,t){this.$el.css("z-index",9999),this.$container.html(this.$box.append(e)),this.setOptions(t),this.open()},setOptions:function(e){e=_.defaults(e||{},this.defaultOptions),_.each(e,function(t,i){switch(i){case"toggle":console.log(i,t),t===!0&&(console.log("popup will close in "+e.toggleDelay+" ms"),this.$el.data("timeout",setTimeout(_.bind(this.close,this),e.toggleDelay)));break;case"trigger":t===!0&&this.$box.append('<div class="close-trigger" />');break;case"size":this.$el.addClass(this.sizes[t]);break;case"className":this.$el.addClass(t);break;case"css":this.$el.css(t)}},this)},closeHandler:function(e){e.target===e.currentTarget&&this.close()},open:function(){this.$el.addClass("open--popup")},close:function(){var e=this.$el.data("timeout");void 0!==e&&clearTimeout(e),this.$el.toggleClass("open--popup close--popup"),setTimeout(_.bind(this.removePopup,this),500)},removePopup:function(){this.$el.replaceWith(this.initial),this.remove()}})),App.Router=Backbone.Router.extend({routes:{"":"index","!/":"index","!/account/signin":"signin","!/account/login":"login","!/account/logout":"logout","!/account/recover":"recover","!/contacts":"contacts"},index:function(){function e(){App.Vent.trigger("collectionLoad",i),App.Helpers.renderContent(s.render().el)}function t(e,t){console.log(t.responseText)}App.Vent.trigger("layoutUpdate");var i=App.create("collection/Carts"),s=App.createLayout("view/Carts");i.fetch({success:e,error:t})},login:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1});var e=App.createForm("model/Login"),t=App.createForm("view/Login",{model:e});App.Helpers.renderContent(t.render().el)},logout:function(){this.navigate("",{trigger:!0,replace:!0})},signin:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1});var e=App.createForm("model/Sigin"),t=App.createForm("view/Sigin",{model:e});App.Helpers.renderContent(t.render().el)},recover:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1});var e=App.createForm("model/Recover"),t=App.createForm("view/Recover",{model:e});App.Helpers.renderContent(t.render().el)},addMedia:function(){},contacts:function(){App.Vent.trigger("layoutUpdateForce",{sidebar:!1}),App.createLayout("view/Contacts").render()}}),App.create("view/Wrapper","layout",{model:App.create("model/Main","layout")}),new App.Router,Backbone.history.start();